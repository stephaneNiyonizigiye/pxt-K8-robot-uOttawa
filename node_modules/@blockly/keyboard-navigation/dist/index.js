/*! For license information please see index.js.LICENSE.txt */
!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e(require("blockly/core"),require("blockly"));else if("function"==typeof define&&define.amd)define(["blockly/core","blockly"],e);else{var o="object"==typeof exports?e(require("blockly/core"),require("blockly")):e(t.Blockly,t.Blockly);for(var n in o)("object"==typeof exports?exports:t)[n]=o[n]}}(this,((t,e)=>(()=>{"use strict";var o={826:t=>{t.exports=e},370:e=>{e.exports=t}},n={};function i(t){var e=n[t];if(void 0!==e)return e.exports;var r=n[t]={exports:{}};return o[t](r,r.exports,i),r.exports}i.d=(t,e)=>{for(var o in e)i.o(e,o)&&!i.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var r={};i.r(r),i.d(r,{KeyboardNavigation:()=>pt});var s,a,c,l=i(370);l.Toolbox.prototype.onKeyDown_=function(){},function(t){t.NOWHERE="nowhere",t.WORKSPACE="workspace",t.FLYOUT="flyout",t.TOOLBOX="toolbox"}(s||(s={})),function(t){t.UP="up",t.DOWN="down",t.RIGHT="right",t.LEFT="left",t.NEXT_STACK="next_stack",t.PREVIOUS_STACK="previous_stack",t.INSERT="insert",t.EDIT_OR_CONFIRM="edit_or_confirm",t.DISCONNECT="disconnect",t.TOOLBOX="toolbox",t.EXIT="exit",t.MENU="menu",t.COPY="keyboard_nav_copy",t.CUT="keyboard_nav_cut",t.PASTE="keyboard_nav_paste",t.DUPLICATE="duplicate",t.MOVE_WS_CURSOR_UP="workspace_up",t.MOVE_WS_CURSOR_DOWN="workspace_down",t.MOVE_WS_CURSOR_LEFT="workspace_left",t.MOVE_WS_CURSOR_RIGHT="workspace_right",t.CREATE_WS_CURSOR="to_workspace",t.LIST_SHORTCUTS="list_shortcuts",t.CLEAN_UP="clean_up_workspace"}(a||(a={})),function(t){t.ERROR="error",t.WARN="warn",t.LOG="log"}(c||(c={}));const u={};u[l.Msg.SHORTCUTS_GENERAL]=[a.MENU,a.EDIT_OR_CONFIRM,a.EXIT,a.TOOLBOX,a.CLEAN_UP,a.LIST_SHORTCUTS],u[l.Msg.SHORTCUTS_EDITING]=[a.INSERT,"delete",a.DISCONNECT,"cut","copy","paste",a.DUPLICATE,"undo","redo"],u[l.Msg.SHORTCUTS_CODE_NAVIGATION]=[a.UP,a.DOWN,a.RIGHT,a.LEFT,a.NEXT_STACK,a.PREVIOUS_STACK];var d=i(826);const g={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"caps-lock",27:"esc",32:"space",33:"pg-up",34:"pg-down",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:"semicolon",61:"equals",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",93:"context",96:"num-0",97:"num-1",98:"num-2",99:"num-3",100:"num-4",101:"num-5",102:"num-6",103:"num-7",104:"num-8",105:"num-9",106:"num-multiply",107:"num-plus",109:"num-minus",110:"num-period",111:"num-division",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",186:"semicolon",187:"equals",189:"dash",188:",",190:".",191:"/",192:"`",219:"open-square-bracket",220:"\\",221:"close-square-bracket",222:"single-quote",224:"win"},h=navigator.platform.startsWith("Mac");function p(t,e){t.indexOf(")")===t.length-1&&(t=t.split(" (")[0]);const o=document.createElement("div");o.className="blocklyShortcutContainer";const n=document.createElement("span");n.textContent=t;const i=document.createElement("span");return i.className="blocklyShortcut",i.textContent=` ${v(e)}`,o.appendChild(n),o.appendChild(i),o}function v(t){return f(t,C)[0].join(h?" ":" + ")}const y={Control:d.Msg.CONTROL_KEY,Meta:d.Msg.COMMAND_KEY,Alt:h?d.Msg.OPTION_KEY:d.Msg.ALT_KEY},C={Control:d.Msg.CONTROL_KEY,Meta:"⌘",Alt:h?"⌥":d.Msg.ALT_KEY};function f(t,e){const o=d.ShortcutRegistry.registry.getKeyCodesByShortcutName(t).map((t=>t.split("+").map((t=>{var e;return null!==(e=g[t])&&void 0!==e?e:t})).map((t=>{var o;return k(null!==(o=e[t])&&void 0!==o?o:t)})))),n=e.Meta,i=e.Alt,r=e.Control;o.sort(((t,e)=>{const o=t.includes(n)?1:0;return(e.includes(n)?1:0)-o}));let s=o.filter((t=>(t.includes(n)||t.includes(i))===h));return s=0===s.length?o:s,s.some((t=>t.some((t=>n===t||i===t||r===t))))?[s[0]]:s}function k(t){return t.charAt(0).toUpperCase()+t.substring(1)}const b="unconstrainedMoveHint",m="constrainedMoveHint",S="copiedHint",w="cutHint",T="helpHint";function R(t,e=!1){const o=v(a.EDIT_OR_CONFIRM),n=`Hold ${navigator.platform.startsWith("Mac")?"⌥":"Ctrl"} and use arrow keys to move freely, then ${o} to accept the position`;d.Toast.show(t,{message:n,id:b,oncePerSession:!e})}class E{constructor(t,e={allowCrossWorkspacePaste:!1}){this.navigation=t,this.options=e}install(){this.registerCopyShortcut(),this.registerCopyContextMenuAction(),this.registerPasteShortcut(),this.registerPasteContextMenuAction(),this.registerCutShortcut(),this.registerCutContextMenuAction()}uninstall(){d.ContextMenuRegistry.registry.unregister("blockCutFromContextMenu"),d.ContextMenuRegistry.registry.unregister("blockCopyFromContextMenu"),d.ContextMenuRegistry.registry.unregister("blockPasteFromContextMenu"),d.ShortcutRegistry.registry.unregister(a.CUT),d.ShortcutRegistry.registry.unregister(a.COPY),d.ShortcutRegistry.registry.unregister(a.PASTE)}registerCutShortcut(){if(this.oldCutShortcut=d.ShortcutRegistry.registry.getRegistry()[d.ShortcutItems.names.CUT],!this.oldCutShortcut)throw new Error("No cut keyboard shortcut registered initially");const t={name:a.CUT,preconditionFn:this.oldCutShortcut.preconditionFn,callback:this.cutCallback.bind(this),keyCodes:this.oldCutShortcut.keyCodes,allowCollision:!1};d.ShortcutRegistry.registry.unregister(d.ShortcutItems.names.CUT),d.ShortcutRegistry.registry.register(t)}registerCutContextMenuAction(){const t={displayText:t=>p(d.Msg.CUT_SHORTCUT,a.CUT),preconditionFn:t=>this.cutPrecondition(t),callback:(t,e)=>{if(!(0,d.isCopyable)(t.focusedNode))return!1;const o=t.focusedNode.workspace;return o instanceof d.WorkspaceSvg&&this.cutCallback(o,e,void 0,t)},id:"blockCutFromContextMenu",weight:12};d.ContextMenuRegistry.registry.register(t)}cutPrecondition(t){var e;const o=t.focusedNode;if(!o||!(0,d.isCopyable)(o))return"hidden";const n=o.workspace;return n instanceof d.WorkspaceSvg?(null===(e=this.oldCutShortcut)||void 0===e?void 0:e.preconditionFn)&&this.oldCutShortcut.preconditionFn(n,t)?"enabled":"disabled":"hidden"}cutCallback(t,e,o={name:a.CUT},n){var i;const r=!!(null===(i=this.oldCutShortcut)||void 0===i?void 0:i.callback)&&this.oldCutShortcut.callback(t,e,o,n);return r&&function(t){d.Toast.show(t,{message:`Cut. Press ${v(a.PASTE)} to paste.`,duration:7,id:w})}(t),r}registerCopyShortcut(){if(this.oldCopyShortcut=d.ShortcutRegistry.registry.getRegistry()[d.ShortcutItems.names.COPY],!this.oldCopyShortcut)throw new Error("No copy keyboard shortcut registered initially");const t={name:a.COPY,preconditionFn:this.oldCopyShortcut.preconditionFn,callback:this.copyCallback.bind(this),keyCodes:this.oldCopyShortcut.keyCodes,allowCollision:!1};d.ShortcutRegistry.registry.unregister(d.ShortcutItems.names.COPY),d.ShortcutRegistry.registry.register(t)}registerCopyContextMenuAction(){const t={displayText:t=>p(d.Msg.COPY_SHORTCUT,a.COPY),preconditionFn:t=>this.copyPrecondition(t),callback:(t,e)=>{if(!(0,d.isCopyable)(t.focusedNode))return!1;const o=t.focusedNode.workspace;return o instanceof d.WorkspaceSvg&&this.copyCallback(o,e,void 0,t)},id:"blockCopyFromContextMenu",weight:13};d.ContextMenuRegistry.registry.register(t)}copyPrecondition(t){var e;const o=t.focusedNode;if(!o||!(0,d.isCopyable)(o))return"hidden";const n=o.workspace;return n instanceof d.WorkspaceSvg?(null===(e=this.oldCopyShortcut)||void 0===e?void 0:e.preconditionFn)&&this.oldCopyShortcut.preconditionFn(n,t)?"enabled":"disabled":"hidden"}copyCallback(t,e,o={name:a.CUT},n){var i;const r=!!(null===(i=this.oldCopyShortcut)||void 0===i?void 0:i.callback)&&this.oldCopyShortcut.callback(t,e,o,n);return r&&function(t){d.Toast.show(t,{message:`Copied. Press ${v(a.PASTE)} to paste.`,duration:7,id:S})}(t),r}registerPasteShortcut(){if(this.oldPasteShortcut=d.ShortcutRegistry.registry.getRegistry()[d.ShortcutItems.names.PASTE],!this.oldPasteShortcut)throw new Error("No paste keyboard shortcut registered initially");const t={name:a.PASTE,preconditionFn:this.oldPasteShortcut.preconditionFn,callback:this.pasteCallback.bind(this),keyCodes:this.oldPasteShortcut.keyCodes,allowCollision:!1};d.ShortcutRegistry.registry.unregister(d.ShortcutItems.names.PASTE),d.ShortcutRegistry.registry.register(t)}registerPasteContextMenuAction(){const t={displayText:t=>p(d.Msg.PASTE_SHORTCUT,a.PASTE),preconditionFn:t=>this.pastePrecondition(t),callback:(t,e)=>{const o=this.getPasteWorkspace(t);return!!o&&this.pasteCallback(o,e,void 0,t)},id:"blockPasteFromContextMenu",weight:14};d.ContextMenuRegistry.registry.register(t)}getPasteWorkspace(t){let e;if(t.focusedNode instanceof d.WorkspaceSvg?e=t.focusedNode:(0,d.isSelectable)(t.focusedNode)&&(e=t.focusedNode.workspace),e&&e instanceof d.WorkspaceSvg)return e}pastePrecondition(t){var e;const o=this.getPasteWorkspace(t);if(!o)return"hidden";if(o.isFlyout)return"hidden";if(!this.options.allowCrossWorkspacePaste){let t=d.clipboard.getLastCopiedWorkspace();if((null==t?void 0:t.isFlyout)&&(t=t.targetWorkspace),t!==o)return"disabled"}return(null===(e=this.oldPasteShortcut)||void 0===e?void 0:e.preconditionFn)&&this.oldPasteShortcut.preconditionFn(o,t)?"enabled":"disabled"}pasteCallback(t,e,o={name:a.CUT},n){var i;const r=!!(null===(i=this.oldPasteShortcut)||void 0===i?void 0:i.callback)&&this.oldPasteShortcut.callback(t,e,o,n);return function(t){d.Toast.hide(t,w),d.Toast.hide(t,S)}(t),r}}class N{constructor(){this.oldDisplayText=void 0,this.oldContextMenuItem=null}install(){this.registerContextMenuAction()}uninstall(){this.oldContextMenuItem&&this.oldDisplayText&&(this.oldContextMenuItem.displayText=this.oldDisplayText)}registerContextMenuAction(){this.oldContextMenuItem=d.ContextMenuRegistry.registry.getItem("blockDelete"),this.oldContextMenuItem&&(this.oldDisplayText=this.oldContextMenuItem.displayText,this.oldContextMenuItem.displayText=t=>{let e;if("function"==typeof this.oldDisplayText){const o=this.oldDisplayText(t);e=o instanceof HTMLElement?o.innerText:o}else e="string"==typeof this.oldDisplayText?this.oldDisplayText:d.Msg.DELETE_BLOCK;return p(e,d.ShortcutItems.names.DELETE)})}}class M{constructor(t){this.navigation=t}install(){this.registerContextMenuAction()}uninstall(){d.ContextMenuRegistry.registry.unregister("edit")}registerContextMenuAction(){const t={displayText:p(d.Msg.EDIT_BLOCK_CONTENTS,a.RIGHT),preconditionFn:(t,e)=>{var o;if(e instanceof PointerEvent)return"hidden";const n=null===(o=t.block)||void 0===o?void 0:o.workspace;if(!n||!this.navigation.canCurrentlyNavigate(n))return"disabled";const i=n.getCursor();return i?i.atEndOfLine()?"hidden":"enabled":"disabled"},callback:t=>{var e,o;d.keyboardNavigationController.setIsActive(!0);const n=null===(e=t.block)||void 0===e?void 0:e.workspace;return!!n&&(null===(o=n.getCursor())||void 0===o||o.in(),!0)},scopeType:d.ContextMenuRegistry.ScopeType.BLOCK,id:"edit",weight:10};d.ContextMenuRegistry.registry.register(t)}}class F extends l.LineCursor{constructor(t){super(t.getWorkspace()),this.flyout=t}next(){const t=this.getCurNode();if(!t)return null;const e=this.workspace.getNavigator().getNextSibling(t);return e&&this.setCurNode(e),e}prev(){const t=this.getCurNode();if(!t)return null;const e=this.workspace.getNavigator().getPreviousSibling(t);return e&&this.setCurNode(e),e}setCurNode(t){let e;if(super.setCurNode(t),t&&"getBoundingRectangle"in t&&"function"==typeof t.getBoundingRectangle)e=t.getBoundingRectangle();else if(t instanceof l.FlyoutButton){const{x:o,y:n}=t.getPosition();e=new l.utils.Rect(n,n+t.height,o,o+t.width)}e instanceof l.utils.Rect&&function(t,e){if(l.Gesture.inProgress())return;const o=e.getScale(),n=e.getMetricsManager().getViewMetrics(!0),i=new l.utils.Rect(n.top,n.top+n.height,n.left,n.left+n.width);if(t.left>=i.left&&t.top>=i.top&&t.right<=i.right&&t.bottom<=i.bottom)return;(t=t.clone()).top-=10,t.bottom+=10,t.left-=10,t.right+=10;let r=0,s=0;t.left<i.left?r=i.left-t.left:t.right>i.right&&(r=i.right-t.right),t.top<i.top?s=i.top-t.top:t.bottom>i.bottom&&(s=i.bottom-t.bottom),r*=o,s*=o,e.scroll(e.scrollX+r,e.scrollY+s)}(e,this.flyout.getWorkspace())}}const x=l.registry.Type.CURSOR,I="FlyoutCursor";l.registry.register(x,I,F),x.toString();class D{constructor(){this.workspaces=[],this.wsChangeWrapper=this.workspaceChangeListener.bind(this),this.flyoutChangeWrapper=this.flyoutChangeListener.bind(this)}addWorkspace(t){this.workspaces.push(t);const e=t.getFlyout();t.addChangeListener(this.wsChangeWrapper),e&&this.addFlyout(e)}removeWorkspace(t){const e=this.workspaces.indexOf(t),o=t.getFlyout();t.getCursor()&&this.disableKeyboardAccessibility(t),e>-1&&this.workspaces.splice(e,1),t.removeChangeListener(this.wsChangeWrapper),o&&this.removeFlyout(o)}getState(){const t=l.getFocusManager();if(t.ephemeralFocusTaken())return s.NOWHERE;const e=t.getFocusedTree();return e instanceof l.WorkspaceSvg?e.isFlyout?s.FLYOUT:s.WORKSPACE:e instanceof l.Toolbox?s.TOOLBOX:e instanceof l.Flyout?s.FLYOUT:s.NOWHERE}addFlyout(t){const e=t.getWorkspace();e.addChangeListener(this.flyoutChangeWrapper);const o=l.registry.getClass(x,I);o&&e.getMarkerManager().setCursor(new o(t))}removeFlyout(t){t.getWorkspace().removeChangeListener(this.flyoutChangeWrapper)}workspaceChangeListener(t){if(!t.workspaceId)return;const e=l.Workspace.getById(t.workspaceId);e&&e.keyboardAccessibilityMode&&t.type===l.Events.BLOCK_CHANGE&&"mutation"===t.element&&this.handleBlockMutation(e,t)}flyoutChangeListener(t){if(!t.workspaceId)return;const e=l.Workspace.getById(t.workspaceId),o=null==e?void 0:e.targetWorkspace;if(!o)return;const n=o.getFlyout();if(n)if(o&&o.keyboardAccessibilityMode&&!n.autoClose){if(t.type===l.Events.CLICK&&"block"===t.targetType){const{blockId:n}=t;if(n){const t=e.getBlockById(n);t&&this.handleBlockClickInFlyout(o,t)}}else if(t.type===l.Events.SELECTED){const{newElementId:n}=t;if(n){const t=e.getBlockById(n);t&&this.handleBlockClickInFlyout(o,t)}}}else t.type===l.Events.BLOCK_CREATE&&this.getState()===s.FLYOUT&&this.defaultFlyoutCursorIfNeeded(o)}isFlyoutItemDisposed(t,e){return!!(null==e?void 0:e.disposed)||t instanceof l.FlyoutButton&&null===t.getSvgRoot().parentNode}handleBlockMutation(t,e){const o=e.blockId,n=t.getCursor(),i=null==n?void 0:n.getSourceBlock();i&&i.id===o&&(null==n||n.setCurNode(i))}handleBlockClickInFlyout(t,e){var o;if(!e)return;const n=e.isShadow()?e:e.getParent();n&&(null===(o=this.getFlyoutCursor(t))||void 0===o||o.setCurNode(n));const i=t.getFlyout();i&&l.getFocusManager().focusTree(i.getWorkspace())}defaultFlyoutCursorIfNeeded(t,e="first"){const o=t.getFlyout();if(!o)return!1;const n=this.getFlyoutCursor(t);if(!n)return!1;const i=n.getCurNode(),r=n.getSourceBlock();if(i&&i!==o.getWorkspace()&&i.getFocusableTree()===o.getWorkspace()&&!this.isFlyoutItemDisposed(i,r))return!1;const s=o.getContents(),a="first"===e?s[0]:s[s.length-1];if(!a)return!1;const c=a.getElement();return n.setCurNode(c),!0}defaultWorkspaceCursorPositionIfNeeded(t,e="first"){var o;const n=t.getTopBlocks(!0),i=t.getCursor();if(!i)return;const r=null===(o=i.getSourceBlock())||void 0===o?void 0:o.disposed;return!(i.getCurNode()&&!r||(n.length>0?i.setCurNode(n["first"===e?0:n.length-1]):i.setCurNode(t),0))}getFlyoutCursor(t){const e=t.getFlyout();return e?e.getWorkspace().getCursor():null}findInsertStartPoint(t,e){var o;const n=!!e.outputConnection;if(t instanceof l.Field){const o=t.getSourceBlock();return o?this.findInsertStartPoint(o,e):null}if(t instanceof l.RenderedConnection){if(!n&&t.type===l.ConnectionType.INPUT_VALUE){const o=t.getSourceBlock();return o?this.findInsertStartPoint(o,e):null}return t}if(t instanceof l.WorkspaceSvg)return null;if(t instanceof l.BlockSvg){const i=n?l.inputs.inputTypes.VALUE:l.inputs.inputTypes.STATEMENT,r=t.inputList.filter((t=>t.type===i)),s=r.length>0?r[0]:null;let a=null==s?void 0:s.connection;if(a){if(i===l.inputs.inputTypes.STATEMENT)for(;null===(o=a.targetBlock())||void 0===o?void 0:o.nextConnection;)a=a.targetBlock().nextConnection;return a}if(t.nextConnection&&!n)return t.nextConnection;if(t.outputConnection){const o=t.outputConnection.targetConnection;if(n&&o)return this.findInsertStartPoint(o,e);if(!n){const o=t.getParent();return o?this.findInsertStartPoint(o,e):null}return t.outputConnection}}return this.warn(`Unexpected case in findInsertStartPoint ${t}.`),null}tryToConnectBlock(t,e){const o=this.findInsertStartPoint(t,e);return!!o&&this.insertBlock(e,o)}disconnectChild(t,e){const o=t.getSourceBlock(),n=e.getSourceBlock();let i;o.getRootBlock()===n.getRootBlock()&&(o.getDescendants(!1).includes(n)?(i=this.getInferiorConnection(e),i&&i.disconnect()):(i=this.getInferiorConnection(t),i&&i.disconnect()))}connect(t,e){if(!t||!e)return!1;const o=this.getInferiorConnection(t),n=this.getSuperiorConnection(e),i=this.getSuperiorConnection(t),r=this.getInferiorConnection(e);if(o&&n&&this.moveAndConnect(o,n))return!0;if(i&&r&&this.moveAndConnect(i,r))return!0;if(this.moveAndConnect(t,e))return!0;{const o=t.getConnectionChecker(),n=o.canConnectWithReason(t,e,!1);return this.warn("Connection failed with error: "+o.getErrorMessage(n,t,e)),!1}}getInferiorConnection(t){if(!t)return null;const e=t.getSourceBlock();return t.isSuperior()?e.previousConnection?e.previousConnection:e.outputConnection?e.outputConnection:null:t}getSuperiorConnection(t){return t?t.isSuperior()?t:t.targetConnection?t.targetConnection:null:null}moveAndConnect(t,e){if(!t||!e)return!1;const o=t.getSourceBlock();if(t.getConnectionChecker().canConnect(t,e,!1)&&!e.getSourceBlock().isShadow()){if(this.disconnectChild(t,e),!e.isSuperior()){const n=o.getRootBlock(),i={x:e.x-t.x,y:e.y-t.y},r=t.getOffsetInBlock().clone();n.positionNearConnection(t,i,r)}return e.connect(t),!0}return!1}insertBlock(t,e){switch(e.type){case l.PREVIOUS_STATEMENT:if(this.connect(t.nextConnection,e))return!0;break;case l.NEXT_STATEMENT:if(this.connect(t.previousConnection,e))return!0;break;case l.INPUT_VALUE:if(this.connect(t.outputConnection,e))return!0;break;case l.OUTPUT_VALUE:for(let o=0;o<t.inputList.length;o++){const n=t.inputList[o].connection;if(n&&n.type===l.INPUT_VALUE&&this.connect(n,e))return!0}if(t.outputConnection&&this.connect(t.outputConnection,e))return!0}return this.warn("This block can not be inserted at the marked location."),!1}enableKeyboardAccessibility(t){this.workspaces.includes(t)&&!t.keyboardAccessibilityMode&&(t.keyboardAccessibilityMode=!0)}disableKeyboardAccessibility(t){this.workspaces.includes(t)&&t.keyboardAccessibilityMode&&(t.keyboardAccessibilityMode=!1)}log(t){console.log(t)}warn(t){console.warn(t)}error(t){console.error(t)}openToolboxOrFlyout(t){const e=t.getToolbox(),o=t.getFlyout();e?l.getFocusManager().focusTree(e):o&&l.getFocusManager().focusTree(o.getWorkspace())}paste(t,e){var o;const n=null===(o=e.getCursor())||void 0===o?void 0:o.getCurNode();l.Events.setGroup(!0);const i=l.clipboard.paste(t,e);return i?(n&&this.tryToConnectBlock(n,i),!0):(l.Events.setGroup(!1),!1)}canCurrentlyNavigate(t){var e,o,n,i;return!!(null!==(i=null!==(n=null!==(e=t.getRootWorkspace())&&void 0!==e?e:null===(o=t.targetWorkspace)||void 0===o?void 0:o.getRootWorkspace())&&void 0!==n?n:t.targetWorkspace)&&void 0!==i?i:t).keyboardAccessibilityMode&&this.getState()!==s.NOWHERE}canCurrentlyEdit(t){return this.canCurrentlyNavigate(t)&&!t.isReadOnly()}dispose(){for(const t of this.workspaces)this.removeWorkspace(t)}}class O{constructor(){this.outputDiv=document.getElementById("shortcuts"),this.open=!1,this.modalContainer=null,this.shortcutDialog=null,this.closeButton=null}getPlatform(){const{platform:t,userAgent:e}=navigator;return t.startsWith("Win")?l.Msg.WINDOWS:t.startsWith("Mac")?l.Msg.MAC_OS:/\bCrOS\b/.test(e)?l.Msg.CHROME_OS:t.includes("Linux")?l.Msg.LINUX:l.Msg.UNKNOWN}updatePlatformName(){const t=this.getPlatform(),e=this.outputDiv?this.outputDiv.querySelector(".platform"):null;e&&(e.textContent=t)}toggle(t){!function(t){d.Toast.hide(t,T)}(t),this.toggleInternal()}toggleInternal(){this.modalContainer&&this.shortcutDialog&&(this.shortcutDialog.hasAttribute("open")?this.shortcutDialog.close():this.shortcutDialog.showModal())}getReadableShortcutName(t){return k(t.replace(/_/gi," "))}createModalContent(){let t='<div class="modal-container">\n      <dialog class="shortcut-modal">\n        <div class="shortcut-container" tabindex="0">\n          <div class="header">\n            <button class="close-modal">\n              <span class="material-symbols-outlined">close</span>\n            </button>\n            <h1>Keyboard shortcuts – <span class="platform">Windows</span></h1>\n          </div>\n          <div class="shortcut-tables">';for(const[e,o]of Object.entries(u)){t+=`\n        <table class="shortcut-table">\n          <tbody>\n          <tr class="category"><th colspan="3"><h2>${e}</h2></th></tr>\n          <tr>\n          `;for(const e of o)t+=`\n              <td>${this.getReadableShortcutName(e)}</td>\n              <td>${this.actionShortcutsToHTML(e)}</td>\n              </tr>`;t+="</tr></tbody></table>"}this.outputDiv&&(this.outputDiv.innerHTML=t+"</div>\n      </dialog>\n    </div>",this.modalContainer=this.outputDiv.querySelector(".modal-container"),this.shortcutDialog=this.outputDiv.querySelector(".shortcut-modal"),this.closeButton=this.outputDiv.querySelector(".close-modal"),this.updatePlatformName(),this.closeButton&&this.closeButton.addEventListener("click",(t=>{this.toggleInternal()})))}actionShortcutsToHTML(t){const e=function(t){return f(t,y)}(t);return e.map((t=>this.actionShortcutToHTML(t))).join(" / ")}actionShortcutToHTML(t){const e=navigator.platform.startsWith("Mac")?"":" + ";return['<span class="shortcut-combo">',...t.map(((o,n)=>`<span class="key">${o}</span>${n<t.length-1?e:""}`)),"</span>"].join("")}install(){const t={name:a.LIST_SHORTCUTS,callback:t=>(this.toggle(t),!0),keyCodes:[l.utils.KeyCodes.SLASH]};l.ShortcutRegistry.registry.register(t)}uninstall(){l.ShortcutRegistry.registry.unregister(a.LIST_SHORTCUTS)}}l.Css.register("\n:root {\n  --divider-border-color: #eee;\n  --key-border-color: #ccc;\n  --shortcut-modal-border-color: #9aa0a6;\n}\n\n.shortcut-modal {\n  border: 1px solid var(--shortcut-modal-border-color);\n  border-radius: 12px;\n  box-shadow: 6px 6px 32px rgba(0,0,0,.5);\n  flex-direction: column;\n  gap: 12px;\n  margin: auto;\n  max-height: 82vh;\n  max-width: calc(100% - 10em);\n  padding: 24px 12px 24px 32px;\n  position: relative;\n  z-index: 99;\n}\n\n.shortcut-modal[open] {\n  display: flex;\n}\n\n.shortcut-modal .close-modal {\n  border: 0;\n  background: transparent;\n  float: inline-end;\n  margin: 0 0 0 0;\n  position: absolute;\n  top: 16px;\n  right: 24px;\n}\n\n.shortcut-modal h1 {\n  font-weight: 600;\n  font-size: 1.2em;\n}\n\n.shortcut-modal:before {\n  background: radial-gradient(rgba(244, 244, 244, 0.43), rgba(75, 75, 75, 0.51));\n  align-items: center;\n  display: block;\n  font-family: Roboto;\n  height: 100%;\n  justify-content: center;\n  left: 0;\n  position: absolute;\n  top: 0;\n  width: 100%;\n}\n\n.shortcut-tables {\n  display: grid;\n  align-items: start;\n  grid-template-columns: 1fr;\n  row-gap: 1em;\n  column-gap: 2em;\n}\n\n@media (min-width: 950px) {\n  .shortcut-tables {\n    grid-template-columns: 1fr 1fr\n  }\n}\n\n@media (min-width: 1360px) {\n  .shortcut-tables {\n    grid-template-columns: 1fr 1fr 1fr\n  }\n}\n\n.shortcut-table {\n  border-collapse: collapse;\n  font-family: Roboto;\n  font-size: .9em;\n}\n\n.shortcut-table th {\n  padding-inline-end: 0.5em;\n  text-align: left;\n  text-wrap: nowrap;\n  vertical-align: baseline;\n}\n\n.shortcut-table td:first-child {\n  text-wrap: auto;\n  width: 40%;\n}\n\n.shortcut-table tr:has(+ .category) {\n  --divider-border-color: transparent;\n  margin-end: 1em;\n}\n\n.shortcut-table tr:not(.category, :last-child) {\n  border-bottom: 1px solid var(--divider-border-color);\n}\n\n.shortcut-table td {\n  padding: 0.2em 1em 0.3em 0;\n  text-wrap: nowrap;\n}\n\n.shortcut-table h2 {\n  border-bottom: 1px solid #999;\n  font-size: 1em;\n  padding-block-end: 0.5em;\n}\n\n.shortcut-table .key {\n  border: 1px solid var(--key-border-color);\n  border-radius: 8px;\n  display: inline-block;\n  margin: 0 4px;\n  min-width: 2em;\n  padding: .3em .5em;\n  text-align: center;\n}\n\n.shortcut-table .separator {\n  color: gray;\n  display: inline-block;\n  padding: 0 0.5em;\n}\n\n.shortcut-container {\n  font-size: 0.95em;\n  overflow: auto;\n  padding: 0.5em;\n}\n\n.shortcut-combo {\n  display: inline-block;\n  padding: 0.25em 0;\n  text-wrap: nowrap;\n}\n\n");const W=d.utils.KeyCodes,A=d.ShortcutRegistry.registry.createSerializedKey.bind(d.ShortcutRegistry.registry);class P{constructor(t){this.navigation=t,this.shortcuts=[{name:a.MOVE_WS_CURSOR_LEFT,preconditionFn:t=>this.navigation.canCurrentlyEdit(t),callback:t=>this.moveWSCursor(t,-1,0),keyCodes:[A(W.A,[W.SHIFT])]},{name:a.MOVE_WS_CURSOR_RIGHT,preconditionFn:t=>this.navigation.canCurrentlyEdit(t),callback:t=>this.moveWSCursor(t,1,0),keyCodes:[A(W.D,[W.SHIFT])]},{name:a.MOVE_WS_CURSOR_UP,preconditionFn:t=>this.navigation.canCurrentlyEdit(t),callback:t=>this.moveWSCursor(t,0,-1),keyCodes:[A(W.W,[W.SHIFT])]},{name:a.MOVE_WS_CURSOR_DOWN,preconditionFn:t=>this.navigation.canCurrentlyEdit(t),callback:t=>this.moveWSCursor(t,0,1),keyCodes:[A(W.S,[W.SHIFT])]},{name:a.CREATE_WS_CURSOR,preconditionFn:t=>!0,callback:t=>{const e=t.isFlyout?t.targetWorkspace:t;return!!e&&(d.keyboardNavigationController.setIsActive(!0),this.createWSCursor(e))},keyCodes:[W.W]}]}install(){for(const t of this.shortcuts)d.ShortcutRegistry.registry.register(t)}uninstall(){for(const t of this.shortcuts)d.ShortcutRegistry.registry.unregister(t.name)}moveWSCursor(t,e,o){return!1}createWSCursor(t){const e=t.getCursor();return!!e&&(e.setCurNode(t),!0)}}const L=l.utils.KeyCodes;class B{constructor(t){this.navigation=t}fieldShortcutHandler(t,e){const o=t.getCursor();if(!o||!o.getCurNode())return!1;const n=o.getCurNode();return n instanceof l.Field&&n.onShortcut(e)}install(){const t=(t,e,o)=>{var n,i;const r=t.getToolbox(),a=t.isFlyout?null===(n=t.targetWorkspace)||void 0===n?void 0:n.getFlyout():t.getFlyout();let c=!1;switch(this.navigation.getState()){case s.WORKSPACE:return c=this.fieldShortcutHandler(t,o),!c&&t&&(this.navigation.defaultWorkspaceCursorPositionIfNeeded(t)||null===(i=t.getCursor())||void 0===i||i.in(),c=!0),c;case s.TOOLBOX:return c=r&&r.selectChild(),!c&&a&&this.navigation.defaultFlyoutCursorIfNeeded(t),!0;default:return!1}},e=(t,e,o)=>{var n,i;const r=t.isFlyout?null===(n=t.targetWorkspace)||void 0===n?void 0:n.getToolbox():t.getToolbox();let a=!1;switch(this.navigation.getState()){case s.WORKSPACE:return a=this.fieldShortcutHandler(t,o),!a&&t&&(this.navigation.defaultWorkspaceCursorPositionIfNeeded(t)||null===(i=t.getCursor())||void 0===i||i.out(),a=!0),a;case s.FLYOUT:return r&&l.getFocusManager().focusTree(r),!0;case s.TOOLBOX:return r&&r.selectParent();default:return!1}},o={right:{name:a.RIGHT,preconditionFn:t=>this.navigation.canCurrentlyNavigate(t),callback:(o,n,i)=>(l.keyboardNavigationController.setIsActive(!0),o.RTL?e(o,0,i):t(o,0,i)),keyCodes:[L.RIGHT]},left:{name:a.LEFT,preconditionFn:t=>this.navigation.canCurrentlyNavigate(t),callback:(o,n,i)=>(l.keyboardNavigationController.setIsActive(!0),o.RTL?t(o,0,i):e(o,0,i)),keyCodes:[L.LEFT]},down:{name:a.DOWN,preconditionFn:t=>this.navigation.canCurrentlyNavigate(t),callback:(t,e,o)=>{var n,i,r;l.keyboardNavigationController.setIsActive(!0);let a=!1;switch(this.navigation.getState()){case s.WORKSPACE:return a=this.fieldShortcutHandler(t,o),!a&&t&&(this.navigation.defaultWorkspaceCursorPositionIfNeeded(t)||null===(n=t.getCursor())||void 0===n||n.next(),a=!0),a;case s.FLYOUT:return a=this.fieldShortcutHandler(t,o),!a&&t.targetWorkspace&&(this.navigation.defaultFlyoutCursorIfNeeded(t.targetWorkspace)||null===(i=t.getCursor())||void 0===i||i.next(),a=!0),a;case s.TOOLBOX:{const e=t.getToolbox();if(e){if(e.getSelectedItem())a=e.selectNext();else{const t=null!==(r=e.getToolboxItems().find((t=>t.isSelectable())))&&void 0!==r?r:null;e.setSelectedItem(t),a=!0}const t=e.getSelectedItem();t&&l.getFocusManager().focusNode(t)}return a}default:return!1}},keyCodes:[L.DOWN]},up:{name:a.UP,preconditionFn:t=>this.navigation.canCurrentlyNavigate(t),callback:(t,e,o)=>{var n,i;l.keyboardNavigationController.setIsActive(!0);let r=!1;switch(this.navigation.getState()){case s.WORKSPACE:return r=this.fieldShortcutHandler(t,o),r||(this.navigation.defaultWorkspaceCursorPositionIfNeeded(t,"last")||null===(n=t.getCursor())||void 0===n||n.prev(),r=!0),r;case s.FLYOUT:return r=this.fieldShortcutHandler(t,o),!r&&t.targetWorkspace&&(this.navigation.defaultFlyoutCursorIfNeeded(t.targetWorkspace,"last")||null===(i=t.getCursor())||void 0===i||i.prev(),r=!0),r;case s.TOOLBOX:{const e=t.getToolbox();if(e){r=e.selectPrevious();const t=e.getSelectedItem();t&&l.getFocusManager().focusNode(t)}return r}default:return!1}},keyCodes:[L.UP]}};for(const t of Object.values(o))l.ShortcutRegistry.registry.register(t)}uninstall(){l.ShortcutRegistry.registry.unregister(a.LEFT),l.ShortcutRegistry.registry.unregister(a.RIGHT),l.ShortcutRegistry.registry.unregister(a.DOWN),l.ShortcutRegistry.registry.unregister(a.UP)}}const _=l.utils.KeyCodes;class U{constructor(t){this.navigation=t}install(){l.ShortcutRegistry.registry.register({name:a.EXIT,preconditionFn:t=>this.navigation.canCurrentlyNavigate(t),callback:t=>{var e,o;switch(this.navigation.getState()){case s.FLYOUT:case s.TOOLBOX:return(0,l.getFocusManager)().focusTree(null!==(e=t.targetWorkspace)&&void 0!==e?e:t),l.Gesture.inProgress()||t.hideChaff(),!0;case s.WORKSPACE:if(t.isMutator){const e=null===(o=t.options.parentWorkspace)||void 0===o?void 0:o.getAllBlocks().map((t=>t.getIcons())).flat().find((e=>{var o;return e instanceof l.icons.MutatorIcon&&e.bubbleIsVisible()&&(null===(o=e.getBubble())||void 0===o?void 0:o.getWorkspace())===t}));if(e)return e.setBubbleVisible(!1),(0,l.getFocusManager)().focusNode(e),!0}return!1;default:return!1}},keyCodes:[_.ESC],allowCollision:!0})}uninstall(){l.ShortcutRegistry.registry.unregister(a.EXIT)}}var K;function H(t){if(!t)return{x:0,y:0};switch(t){case K.Up:return{x:0,y:-1};case K.Down:return{x:0,y:1};case K.Left:return{x:-1,y:0};case K.Right:return{x:1,y:0}}}!function(t){t[t.Up=1]="Up",t[t.Down=2]="Down",t[t.Left=3]="Left",t[t.Right=4]="Right"}(K||(K={}));class G{constructor(t){this.sourceElement=t,this.location=new l.utils.Coordinate(0,0);const e=t.workspace;this.svgRoot=l.utils.dom.createSvgElement(l.utils.Svg.G,{},e.getBubbleCanvas());const o=e.RTL;l.utils.dom.createSvgElement(l.utils.Svg.CIRCLE,{fill:"white","fill-opacity":"0.8",stroke:"grey","stroke-width":"1",r:20,cx:20*(o?-1:1),cy:20},this.svgRoot),l.utils.dom.createSvgElement(l.utils.Svg.PATH,{fill:"none",stroke:"black","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"m18 9l3 3l-3 3m-3-3h6M6 9l-3 3l3 3m-3-3h6m0 6l3 3l3-3m-3-3v6m3-15l-3-3l-3 3m3-3v6",transform:`translate(${8*(o?-4:1)} 8)`},this.svgRoot),this.updateLocation()}isMovable(){return!1}getSvgRoot(){return this.svgRoot}updateLocation(){var t;const e=this.sourceElement instanceof l.BlockSvg?this.sourceElement.getBoundingRectangleWithoutChildren():this.sourceElement.getBoundingRectangle(),o=this.sourceElement.workspace.RTL?e.left+20:e.right-20,n=e.top-20;this.moveTo(o,n),null===(t=this.sourceElement.workspace.getLayerManager())||void 0===t||t.moveToDragLayer(this)}moveTo(t,e){this.location.x=t,this.location.y=e,this.svgRoot.setAttribute("transform",`translate(${t}, ${e})`)}getRelativeToSurfaceXY(){return this.location}dispose(){l.utils.dom.removeNode(this.svgRoot)}showContextMenu(){}setDragging(t){}startDrag(t){}drag(t,e){}moveDuringDrag(t){}endDrag(){}revertDrag(){}setDeleteStyle(t){}getFocusableElement(){throw new Error("This node is not focusable.")}getFocusableTree(){throw new Error("This node is not focusable.")}onNodeFocus(){}onNodeBlur(){}canBeFocused(){return!1}}class V{constructor(t){this.sourceBlock=t,this.moveIndicator=new G(this.sourceBlock)}getType(){return V.type}getWeight(){return-1}getSize(){return new l.utils.Size(-8,0)}isShownWhenCollapsed(){return!1}isClickableInFlyout(){return!1}bubbleIsVisible(){return!0}getBubble(){return this.moveIndicator}onLocationChange(t){var e;null===(e=this.moveIndicator)||void 0===e||e.updateLocation()}dispose(){var t;null===(t=this.moveIndicator)||void 0===t||t.dispose()}applyColour(){}hideForInsertionMarker(){}updateEditable(){}updateCollapsed(){}setOffsetInBlock(){}onClick(){}setBubbleVisible(t){return e=this,o=void 0,i=function*(){},new((n=void 0)||(n=Promise))((function(t,r){function s(t){try{c(i.next(t))}catch(t){r(t)}}function a(t){try{c(i.throw(t))}catch(t){r(t)}}function c(e){var o;e.done?t(e.value):(o=e.value,o instanceof n?o:new n((function(t){t(o)}))).then(s,a)}c((i=i.apply(e,o||[])).next())}));var e,o,n,i}initView(t){}getFocusableElement(){throw new Error("This node is not focusable.")}getFocusableTree(){throw new Error("This node is not focusable.")}onNodeFocus(){}onNodeBlur(){}canBeFocused(){return!1}}V.type=new l.icons.IconType("moveIndicator");class Y extends d.dragging.BlockDragStrategy{constructor(t,e,o){super(t),this.block=t,this.moveType=e,this.startPoint=o,this.currentDragDirection=null,this.searchNode=null}startDrag(t){super.startDrag(t),this.block.moveDuringDrag(this.startLoc),this.connectionCandidate=this.createInitialCandidate(),this.forceShowPreview(),this.block.addIcon(new V(this.block))}drag(t,e){if(e)if(this.currentDragDirection=function(t){const{x:e,y:o}=t;if(0==e){if(-1==o)return K.Up;if(1==o)return K.Down}else if(0==o){if(-1==e)return K.Left;if(1==e)return K.Right}return null}({x:e.tiltX,y:e.tiltY}),super.drag(t),this.connectionCandidate){const t=this.connectionCandidate.neighbour;this.searchNode=t,this.isConstrainedMovement()&&this.block.moveDuringDrag(new d.utils.Coordinate(t.x+10,t.y+10))}else this.searchNode=null,this.isConstrainedMovement()&&R(this.workspace,!0)}endDrag(t){super.endDrag(t),this.block.removeIcon(V.type)}getConstrainedConnectionCandidate(t){const e=this.getLocalConnections(t);if(0==e.length)return null;let o=this.findTraversalCandidate(t,e);return o||this.searchNode||(o=this.findNearestCandidate(e)),o}findNearestCandidate(t){let e=1/0,o=null;const n=new d.utils.Coordinate(0,0);for(const i of t){const{connection:t,radius:r}=i.closest(e,n);t&&(o={local:i,neighbour:t,distance:r},e=r)}return o}findTraversalCandidate(t,e){var o,n;const i=t.workspace.connectionChecker;let r=null,s=this.searchNode;const a=[];for(const e of t.workspace.getTopBlocks(!0))a.push(...e.getDescendants(!0).flatMap((t=>t.getConnections_(!1))).sort(((t,e)=>{let o=t.y-e.y;return 0===o&&(o=t.x-e.x),o})));const c=this.currentDragDirection;for(;s&&!r;){const t=a.indexOf(s);if(c===K.Up||c===K.Left?s=null!==(o=a[t-1])&&void 0!==o?o:a[a.length-1]:c!==K.Down&&c!==K.Right||(s=null!==(n=a[t+1])&&void 0!==n?n:a[0]),e.forEach((t=>{s&&i.canConnect(t,s,!0,1/0)&&(r={local:t,neighbour:s,distance:0})})),s==this.searchNode)break}return r}currCandidateIsBetter(t,e,o){return!this.isConstrainedMovement()&&super.currCandidateIsBetter(t,e,o)}getConnectionCandidate(t,e){return this.isConstrainedMovement()?this.getConstrainedConnectionCandidate(t):super.getConnectionCandidate(t,e)}isConstrainedMovement(){return!!this.currentDragDirection}forceShowPreview(){const t=this.connectionPreviewer,e=this.connectionCandidate;if(!e||!t)return;const o=this.block,{local:n,neighbour:i}=e,r=n.type===d.ConnectionType.OUTPUT_VALUE||n.type===d.ConnectionType.PREVIOUS_STATEMENT,s=i.targetBlock(),a=s&&!s.isInsertionMarker(),c=s&&this.orphanCanConnectAtEnd(o,s,n.type);r&&a&&!c?t.previewReplacement(n,i,s):t.previewConnection(n,i),o.moveDuringDrag(new d.utils.Coordinate(i.x+10,i.y+10))}createInitialCandidate(){var t;const e=null!==(t=this.startPoint)&&void 0!==t?t:this.startParentConn;if(e)switch(this.searchNode=e,e.type){case d.ConnectionType.INPUT_VALUE:if(this.block.outputConnection)return{neighbour:e,local:this.block.outputConnection,distance:0};break;case d.ConnectionType.NEXT_STATEMENT:if(this.block.previousConnection)return{neighbour:e,local:this.block.previousConnection,distance:0}}return null}shouldHealStack(t){return Boolean(this.block.previousConnection)}}const z="commitMove";var X;!function(t){t[t.Insert=0]="Insert",t[t.Move=1]="Move"}(X||(X={}));class j{constructor(t){this.navigation=t,this.moves=new Map,this.oldDragStrategy=null}canMove(t,e){return!(this.navigation.getState()!==s.WORKSPACE||!this.navigation.canCurrentlyEdit(t)||this.moves.has(t)||!(null==e?void 0:e.isMovable()))}isMoving(t){return this.navigation.canCurrentlyEdit(t)&&this.moves.has(t)}startMove(t,e,o,n){var i;e instanceof d.BlockSvg?this.patchDragStrategy(e,o,n):e instanceof d.comments.RenderedWorkspaceComment&&(this.moveIndicator=new G(e));const r=d.registry.getClassFromOptions(d.registry.Type.BLOCK_DRAGGER,t.options,!0);if(!r)throw new Error("no Dragger registered");const s=new r(e,t),a=()=>{this.finishMove(t)};t.setKeyboardMoveInProgress(!0);const c=new $(t,e,s,a);this.moves.set(t,c),s.onDragStart(c.fakePointerEvent("pointerdown")),c.updateTotalDelta(),null===(i=t.getCursor())||void 0===i||i.setCurNode(e),e.getFocusableElement().addEventListener("blur",a);const l=Object.values(d.ShortcutRegistry.registry.getRegistry()).flatMap((t=>t.keyCodes)).filter((t=>t&&![d.utils.KeyCodes.RIGHT,d.utils.KeyCodes.LEFT,d.utils.KeyCodes.UP,d.utils.KeyCodes.DOWN,d.utils.KeyCodes.ENTER,d.utils.KeyCodes.ESC].includes("number"==typeof t?t:parseInt(`${t.split("+").pop()}`)))).filter((t=>!!t)),u={name:z,preconditionFn:t=>!!this.moves.get(t),callback:t=>(this.finishMove(t),!1),keyCodes:l,allowCollision:!0};return d.ShortcutRegistry.registry.register(u),!0}finishMove(t){const e=this.preDragEndCleanup(t);return e.dragger.onDragEnd(e.fakePointerEvent("pointerup"),new d.utils.Coordinate(0,0)),this.postDragEndCleanup(t,e),!0}abortMove(t){var e,o;const n=this.preDragEndCleanup(t),i=n.draggable.dragStrategy;this.patchDragger(n.dragger,i.moveType);const r=null===(e=i.connectionCandidate)||void 0===e?void 0:e.neighbour;return i.connectionCandidate=null,n.dragger.onDragEnd(n.fakePointerEvent("pointerup"),n.startLocation),i.moveType===X.Insert&&r&&(null===(o=t.getCursor())||void 0===o||o.setCurNode(r)),this.postDragEndCleanup(t,n),!0}preDragEndCleanup(t){d.ShortcutRegistry.registry.unregister(z),function(t){d.Toast.hide(t,m),d.Toast.hide(t,b)}(t);const e=this.moves.get(t);if(!e)throw new Error("no move info for workspace");return e.draggable.getFocusableElement().removeEventListener("blur",e.blurListener),e}postDragEndCleanup(t,e){var o;null===(o=this.moveIndicator)||void 0===o||o.dispose(),this.moveIndicator=void 0,e.draggable instanceof d.BlockSvg&&this.unpatchDragStrategy(e.draggable),this.moves.delete(t),t.setKeyboardMoveInProgress(!1),setTimeout((()=>this.scrollCurrentElementIntoView(t)),0),(0,d.getFocusManager)().focusNode(e.draggable)}moveConstrained(t,e){if(!t)return!1;const o=this.moves.get(t);if(!o)throw new Error("no move info for workspace");return o.draggable instanceof d.comments.RenderedWorkspaceComment?this.moveUnconstrained(t,e):(o.dragger.onDrag(o.fakePointerEvent("pointermove",e),o.totalDelta.clone().scale(t.scale)),o.updateTotalDelta(),this.scrollCurrentElementIntoView(t,70),!0)}moveUnconstrained(t,e){var o;if(!t)return!1;const n=this.moves.get(t);if(!n)throw new Error("no move info for workspace");const{x:i,y:r}=H(e);return n.totalDelta.x+=20*i*t.scale,n.totalDelta.y+=20*r*t.scale,n.dragger.onDrag(n.fakePointerEvent("pointermove"),n.totalDelta.clone().scale(t.scale)),this.scrollCurrentElementIntoView(t),null===(o=this.moveIndicator)||void 0===o||o.updateLocation(),!0}patchDragStrategy(t,e,o){this.oldDragStrategy=t.dragStrategy,t.setDragStrategy(new Y(t,e,o))}unpatchDragStrategy(t){this.oldDragStrategy&&(t.setDragStrategy(this.oldDragStrategy),this.oldDragStrategy=null)}scrollCurrentElementIntoView(t,e=0){var o;const n=null===(o=this.moves.get(t))||void 0===o?void 0:o.draggable;if(n){const o=(n instanceof d.BlockSvg?n.getBoundingRectangleWithoutChildren():n.getBoundingRectangle()).clone();o.top-=e,o.bottom+=e,o.left-=e,o.right+=e,t.scrollBoundsIntoView(o)}}patchDragger(t,e){e===X.Insert?t.wouldDeleteDraggable=()=>!0:t.shouldReturnToStart=()=>!0}}class ${constructor(t,e,o,n){var i,r,s,a;this.workspace=t,this.draggable=e,this.dragger=o,this.blurListener=n,this.totalDelta=new d.utils.Coordinate(0,0),this.parentNext=null,this.parentInput=null,e instanceof d.BlockSvg&&(this.parentNext=null!==(r=null===(i=e.previousConnection)||void 0===i?void 0:i.targetConnection)&&void 0!==r?r:null,this.parentInput=null!==(a=null===(s=e.outputConnection)||void 0===s?void 0:s.targetConnection)&&void 0!==a?a:null),this.startLocation=e.getRelativeToSurfaceXY()}fakePointerEvent(t,e){const o=d.utils.svgMath.wsToScreenCoordinates(this.workspace,new d.utils.Coordinate(this.startLocation.x+this.totalDelta.x,this.startLocation.y+this.totalDelta.y)),n=H(e);return new PointerEvent(t,{clientX:o.x,clientY:o.y,tiltX:n.x,tiltY:n.y})}updateTotalDelta(){this.draggable instanceof d.BlockSvg?this.totalDelta=new d.utils.Coordinate(this.draggable.relativeCoords.x-this.startLocation.x,this.draggable.relativeCoords.y-this.startLocation.y):this.totalDelta=new d.utils.Coordinate(this.draggable.getBoundingRectangle().left-this.startLocation.x,this.draggable.getBoundingRectangle().top-this.startLocation.y)}}const q=l.utils.KeyCodes;class Q{constructor(t,e){this.mover=t,this.navigation=e}install(){l.ShortcutRegistry.registry.register({name:a.EDIT_OR_CONFIRM,preconditionFn:t=>{switch(this.navigation.getState()){case s.WORKSPACE:return this.shouldHandleEnterForWS(t);case s.FLYOUT:{const e=t.isFlyout?t.targetWorkspace:t;return!!e&&this.navigation.canCurrentlyEdit(e)}default:return!1}},callback:(t,e)=>{e.preventDefault();const o=t.isFlyout?t.targetWorkspace:t;if(!o)return!1;let n,i;switch(this.navigation.getState()){case s.WORKSPACE:return this.handleEnterForWS(t);case s.FLYOUT:return n=this.navigation.getFlyoutCursor(o),!!n&&(i=n.getCurNode(),i instanceof l.BlockSvg?this.insertFromFlyout(o):i instanceof l.FlyoutButton&&this.triggerButtonCallback(o),!0);default:return!1}},keyCodes:[q.ENTER,q.SPACE]})}shouldHandleEnterForWS(t){if(!this.navigation.canCurrentlyNavigate(t))return!1;const e=t.getCursor(),o=null==e?void 0:e.getCurNode();return!!o&&(o instanceof l.Field?o.isClickable():o instanceof l.RenderedConnection||o instanceof l.WorkspaceSvg?!t.isReadOnly():o instanceof l.BlockSvg||o instanceof l.icons.Icon||o instanceof l.comments.CommentBarButton||o instanceof l.comments.RenderedWorkspaceComment)}handleEnterForWS(t){const e=t.getCursor(),o=null==e?void 0:e.getCurNode();return!(!o||(o instanceof l.Field?(o.showEditor(),0):o instanceof l.BlockSvg?(this.tryShowFullBlockFieldEditor(o)||function(t){const e=v("list_shortcuts"),o=d.Msg.HELP_PROMPT.replace("%1",e),n=T;d.Toast.show(t,{message:o,id:n})}(t),0):o instanceof l.RenderedConnection||o instanceof l.WorkspaceSvg?(this.navigation.openToolboxOrFlyout(t),0):o instanceof l.icons.Icon?(o.onClick(),o instanceof l.icons.MutatorIcon&&l.renderManagement.finishQueuedRenders().then((()=>{null==e||e.in()})),0):!(o instanceof l.comments.CommentBarButton?(o.performAction(),!0):o instanceof l.comments.RenderedWorkspaceComment&&(o.setCollapsed(!1),(0,l.getFocusManager)().focusNode(o.getEditorFocusableNode()),!0))))}insertFromFlyout(t){var e;t.setResizesEnabled(!1),l.Events.getGroup()||l.Events.setGroup(!0);const o=null!==(e=l.FocusableTreeTraverser.findFocusedNode(t))&&void 0!==e?e:t.getRestoredFocusableNode(null),n=this.createNewBlock(t);if(!n)return;const i=o?this.navigation.findInsertStartPoint(o,n):null;t.getTopBlocks().includes(n)&&this.positionNewTopLevelBlock(t,n),t.setResizesEnabled(!0),this.mover.startMove(t,n,X.Insert,i),n.outputConnection||n.nextConnection||n.previousConnection?function(t){const e=`Use the arrow keys to move, then ${v(a.EDIT_OR_CONFIRM)} to accept the position`;d.Toast.show(t,{message:e,id:m,oncePerSession:!0})}(t):R(t,!1)}positionNewTopLevelBlock(t,e){var o;const n=t.getTopBlocks(!0).filter((t=>t.id!==e.id)).map((t=>t.getBoundingRectangle())),i=null===(o=t.getToolbox())||void 0===o?void 0:o.getWidth(),r=t.getParentSvg().clientWidth-(null!=i?i:0),{height:s,width:a}=(t.getParentSvg().clientHeight,e.getHeightWidth()),c=function(t){for(const e of n)if(t.intersects(e))return e;return null};let l=10,u=10;const d=t.getRenderer().getConstants().MIN_BLOCK_HEIGHT;let g=e.getBoundingRectangle();e.moveBy(u-g.left,l-g.top,["cleanup"]),e.snapToGrid(),g=e.getBoundingRectangle();let h=c(g);for(;null!=h;){const t=h.left+h.getWidth()+80,o=h.top+h.getHeight()+d;t+a<=r?u=t:(l=o,u=10),e.moveBy(u-g.left,l-g.top,["cleanup"]),e.snapToGrid(),g=e.getBoundingRectangle(),h=c(g)}e.bringToFront()}triggerButtonCallback(t){var e;const o=null===(e=this.navigation.getFlyoutCursor(t))||void 0===e?void 0:e.getCurNode();if(!(o instanceof l.FlyoutButton))return;const n=t.flyoutButtonCallbacks,i=o.info;if("callbackkey"in i){const t=n.get(i.callbackkey);if(!t)throw new Error("No callback function found for flyout button.");t(o)}}tryShowFullBlockFieldEditor(t){if(t.isSimpleReporter())for(const e of t.inputList)for(const t of e.fieldRow)if(t.isClickable()&&t.isFullBlockField())return t.showEditor(),!0;return!1}createNewBlock(t){var e;const o=t.getFlyout();if(!o||!o.isVisible())return console.warn("Trying to insert from the flyout when the flyout does not  exist or is not visible"),null;const n=null===(e=this.navigation.getFlyoutCursor(t))||void 0===e?void 0:e.getCurNode();if(!(n instanceof l.BlockSvg&&n.isEnabled()))return console.warn("Can't insert a disabled block."),null;const i=o.createBlock(n);return i.render(),i.setConnectionTracking(!0),i}uninstall(){l.ShortcutRegistry.registry.unregister(a.EDIT_OR_CONFIRM)}}const J=d.utils.KeyCodes;class Z{constructor(t){this.navigation=t,this.shortcutName=a.DISCONNECT}install(){this.registerShortcut()}uninstall(){d.ShortcutRegistry.registry.unregister(this.shortcutName)}registerShortcut(){const t={name:this.shortcutName,preconditionFn:t=>this.navigation.canCurrentlyEdit(t),callback:t=>(d.keyboardNavigationController.setIsActive(!0),this.navigation.getState()===s.WORKSPACE&&(this.disconnectBlocks(t),!0)),keyCodes:[J.X]};d.ShortcutRegistry.registry.register(t)}disconnectBlocks(t){var e;const o=t.getCursor();if(!o)return;const n=o.getCurNode();if(!(n instanceof d.BlockSvg))return;const i=!(null===(e=n.outputConnection)||void 0===e?void 0:e.isConnected());d.Events.setGroup(!0),n.unplug(i),d.Events.setGroup(!1),o.setCurNode(n)}}const tt=d.utils.KeyCodes,et=d.ShortcutRegistry.registry.createSerializedKey.bind(d.ShortcutRegistry.registry);class ot{constructor(t){this.navigation=t,this.shortcutName=a.MENU}install(){this.registerShortcut()}uninstall(){d.ShortcutRegistry.registry.unregister(this.shortcutName)}registerShortcut(){const t={name:a.MENU,preconditionFn:t=>this.navigation.canCurrentlyNavigate(t)&&!t.isDragging(),callback:t=>{switch(this.navigation.getState()){case s.WORKSPACE:case s.FLYOUT:return this.openActionMenu(t);default:return!1}},keyCodes:[et(tt.ENTER,[tt.CTRL]),et(tt.ENTER,[tt.ALT]),et(tt.ENTER,[tt.META])]};d.ShortcutRegistry.registry.register(t)}openActionMenu(t){const e=new KeyboardEvent("keydown"),o=t.getCursor();if(!o)throw new Error("workspace has no cursor");const n=o.getCurNode();return!!n&&("showContextMenu"in n&&"function"==typeof n.showContextMenu?(n.showContextMenu(e),setTimeout((()=>{var t,e;null===(e=null===(t=d.WidgetDiv.getDiv())||void 0===t?void 0:t.querySelector(".blocklyMenu"))||void 0===e||e.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown",code:"ArrowDown",keyCode:tt.DOWN,which:tt.DOWN,bubbles:!0,cancelable:!0}))}),10),!0):(console.info(`No action menu for node ${n}`),!1))}}const nt=d.utils.KeyCodes,it=d.ShortcutRegistry.registry.createSerializedKey.bind(d.ShortcutRegistry.registry);class rt{constructor(t){this.mover=t,this.shortcutNames=[],this.menuItemNames=[]}registerShortcuts(){const t=[{name:"start_move",preconditionFn:t=>{const e=this.getCurrentDraggable(t);return!!e&&this.mover.canMove(t,e)},callback:t=>{d.keyboardNavigationController.setIsActive(!0);const e=this.getCurrentDraggable(t);return e&&(0,d.getFocusManager)().focusNode(e),!!e&&this.mover.startMove(t,e,X.Move,null)},keyCodes:[nt.M]},{name:"finish_move",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.finishMove(t),keyCodes:[nt.ENTER,nt.SPACE],allowCollision:!0},{name:"abort_move",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.abortMove(t),keyCodes:[nt.ESC],allowCollision:!0},{name:"move_left_constrained",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.moveConstrained(t,K.Left),keyCodes:[nt.LEFT],allowCollision:!0},{name:"move_right_constrained",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.moveConstrained(t,K.Right),keyCodes:[nt.RIGHT],allowCollision:!0},{name:"move_up_constrained",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.moveConstrained(t,K.Up),keyCodes:[nt.UP],allowCollision:!0},{name:"move_down_constrained",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.moveConstrained(t,K.Down),keyCodes:[nt.DOWN],allowCollision:!0},{name:"move_left_unconstrained",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.moveUnconstrained(t,K.Left),keyCodes:[it(nt.LEFT,[nt.ALT]),it(nt.LEFT,[nt.CTRL])]},{name:"move_right_unconstrained",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.moveUnconstrained(t,K.Right),keyCodes:[it(nt.RIGHT,[nt.ALT]),it(nt.RIGHT,[nt.CTRL])]},{name:"move_up_unconstrained",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.moveUnconstrained(t,K.Up),keyCodes:[it(nt.UP,[nt.ALT]),it(nt.UP,[nt.CTRL])]},{name:"move_down_unconstrained",preconditionFn:t=>this.mover.isMoving(t),callback:t=>this.mover.moveUnconstrained(t,K.Down),keyCodes:[it(nt.DOWN,[nt.ALT]),it(nt.DOWN,[nt.CTRL])]}];for(const e of t)d.ShortcutRegistry.registry.register(e),this.shortcutNames.push(e.name)}registerMenuItems(){var t;const e=[{displayText:p(d.Msg.MOVE_BLOCK,"start_move"),preconditionFn:(t,e)=>{var o;const n=null===(o=t.block)||void 0===o?void 0:o.workspace;if(!n||e instanceof PointerEvent)return"hidden";const i=this.getCurrentDraggable(n);return i&&this.mover.canMove(n,i)?"enabled":"disabled"},callback:t=>{var e;const o=null===(e=t.block)||void 0===e?void 0:e.workspace;if(!o)return!1;const n=this.getCurrentDraggable(o);return n&&(0,d.getFocusManager)().focusNode(n),!!n&&this.mover.startMove(o,n,X.Move,null)},scopeType:d.ContextMenuRegistry.ScopeType.BLOCK,id:"move",weight:8.5},{displayText:p(null!==(t=d.Msg.MOVE_COMMENT)&&void 0!==t?t:"Move Comment","start_move"),preconditionFn:(t,e)=>{const o=t.comment;return o?this.mover.canMove(o.workspace,o)?"enabled":"disabled":"hidden"},callback:t=>{const e=t.comment;if(!e)return!1;this.mover.startMove(e.workspace,e,X.Move,null)},scopeType:d.ContextMenuRegistry.ScopeType.COMMENT,id:"move_comment",weight:8.5}];for(const t of e)d.ContextMenuRegistry.registry.register(t),this.menuItemNames.push(t.id)}install(){this.registerShortcuts(),this.registerMenuItems()}uninstall(){for(const t of this.shortcutNames)d.ShortcutRegistry.registry.unregister(t);for(const t of this.menuItemNames)d.ContextMenuRegistry.registry.unregister(t)}getCurrentDraggable(t){var e;const o=(0,d.getFocusManager)().getFocusedNode();if(o instanceof d.comments.RenderedWorkspaceComment)return o;let n=null===(e=null==t?void 0:t.getCursor())||void 0===e?void 0:e.getSourceBlock();if(n){for(;n.isShadow();)if(n=n.getParent(),!n)throw new Error("Tried to drag a shadow block with no parent. Shadow blocks should always have parents.");return n}}}class st{constructor(){this.duplicateShortcut=null,this.uninstallHandlers=[]}install(){this.duplicateShortcut=this.registerDuplicateShortcut(),this.duplicateShortcut&&(this.uninstallHandlers.push(at("blockDuplicate",a.DUPLICATE)),this.uninstallHandlers.push(at("commentDuplicate",a.DUPLICATE)))}uninstall(){this.uninstallHandlers.forEach((t=>t())),this.uninstallHandlers.length=0,this.duplicateShortcut&&d.ShortcutRegistry.registry.unregister(this.duplicateShortcut.name)}registerDuplicateShortcut(){if(d.ShortcutRegistry.registry.getRegistry()[a.DUPLICATE])return null;const t={name:a.DUPLICATE,preconditionFn(t,e){const{focusedNode:o}=e;return o instanceof d.BlockSvg?!o.isInFlyout&&o.isDeletable()&&o.isMovable()&&o.isDuplicatable():o instanceof d.comments.RenderedWorkspaceComment&&o.isMovable()},callback(t,e,o,n){const i=n.focusedNode.toCopyData();return!!i&&!!d.clipboard.paste(i,t)},keyCodes:[d.utils.KeyCodes.D]};return d.ShortcutRegistry.registry.register(t),t}}function at(t,e){const o=d.ContextMenuRegistry.registry.getItem(t);if(!o||"separator"in o)return()=>{};const n=Object.assign(Object.assign({},o),{displayText:t=>{const n="function"==typeof o.displayText?o.displayText(t):o.displayText;return n instanceof HTMLElement?n:p(n,e)}});return d.ContextMenuRegistry.registry.unregister(t),d.ContextMenuRegistry.registry.register(n),()=>{d.ContextMenuRegistry.registry.unregister(t),d.ContextMenuRegistry.registry.register(o)}}class ct{constructor(){this.stackShortcuts=[]}install(){const t=t=>!!e(t);function e(t){var e,o;const n=t.getCursor();return null!==(o=null===(e=n.getSourceBlock())||void 0===e?void 0:e.getRootBlock())&&void 0!==o?o:n.getCurNode()}const o={name:a.PREVIOUS_STACK,preconditionFn:t,callback:t=>{const o=e(t);if(!o)return!1;const n=t.getNavigator().getPreviousSibling(o);return!!n&&(t.getCursor().setCurNode(n),!0)},keyCodes:[l.utils.KeyCodes.B]},n={name:a.NEXT_STACK,preconditionFn:t,callback:t=>{const o=e(t);if(!o)return!1;const n=t.getNavigator().getNextSibling(o);return!!n&&(t.getCursor().setCurNode(n),!0)},keyCodes:[l.utils.KeyCodes.N]};l.ShortcutRegistry.registry.register(o),this.stackShortcuts.push(o),l.ShortcutRegistry.registry.register(n),this.stackShortcuts.push(n)}uninstall(){this.stackShortcuts.forEach((t=>l.ShortcutRegistry.registry.unregister(t.name))),this.stackShortcuts.length=0}}const lt=l.utils.KeyCodes;class ut{constructor(t={allowCrossWorkspacePaste:!1}){this.options=t,this.navigation=new D,this.mover=new j(this.navigation),this.shortcutDialog=new O,this.deleteAction=new N,this.editAction=new M(this.navigation),this.disconnectAction=new Z(this.navigation),this.duplicateAction=new st,this.workspaceMovement=new P(this.navigation),this.arrowNavigation=new B(this.navigation),this.exitAction=new U(this.navigation),this.enterAction=new Q(this.mover,this.navigation),this.actionMenu=new ot(this.navigation),this.moveActions=new rt(this.mover),this.stackNavigationAction=new ct,this.origToolboxOnShortcut=null,this.shortcuts={focusToolbox:{name:a.TOOLBOX,preconditionFn:t=>!t.isDragging(),callback:t=>{var e,o,n;return l.keyboardNavigationController.setIsActive(!0),this.navigation.getState()===s.WORKSPACE&&(l.getFocusManager().focusTree(null!==(n=null!==(e=t.getToolbox())&&void 0!==e?e:null===(o=t.getFlyout())||void 0===o?void 0:o.getWorkspace())&&void 0!==n?n:t),!0)},keyCodes:[lt.T]},cleanup:{name:a.CLEAN_UP,preconditionFn:t=>this.navigation.canCurrentlyEdit(t)&&t.getTopBlocks(!1).length>0,callback:t=>(t.cleanUp(),!0),keyCodes:[lt.C]}},this.clipboard=new E(this.navigation,t)}init(){this.addShortcutHandlers(),this.registerDefaults()}addShortcutHandlers(){this.origToolboxOnShortcut=l.Toolbox.prototype.onShortcut,l.Toolbox.prototype.onShortcut=this.toolboxHandler}removeShortcutHandlers(){if(!this.origToolboxOnShortcut)throw new Error("no original onShortcut method recorded");l.Toolbox.prototype.onShortcut=this.origToolboxOnShortcut,this.origToolboxOnShortcut=null}toolboxHandler(t){if(!this.selectedItem_)return!1;switch(t.name){case a.UP:return this.selectPrevious();case a.LEFT:return this.selectParent();case a.DOWN:return this.selectNext();case a.RIGHT:return this.selectChild();default:return!1}}addWorkspace(t){this.navigation.addWorkspace(t)}removeWorkspace(t){this.navigation.removeWorkspace(t)}enable(t){this.navigation.enableKeyboardAccessibility(t)}disable(t){this.navigation.disableKeyboardAccessibility(t)}registerDefaults(){for(const t of Object.values(this.shortcuts))l.ShortcutRegistry.registry.register(t);this.deleteAction.install(),this.workspaceMovement.install(),this.arrowNavigation.install(),this.editAction.install(),this.exitAction.install(),this.enterAction.install(),this.disconnectAction.install(),this.actionMenu.install(),this.clipboard.install(),this.duplicateAction.install(),this.moveActions.install(),this.shortcutDialog.install(),this.stackNavigationAction.install(),this.shortcutDialog.createModalContent()}dispose(){this.moveActions.uninstall(),this.deleteAction.uninstall(),this.editAction.uninstall(),this.disconnectAction.uninstall(),this.clipboard.uninstall(),this.duplicateAction.uninstall(),this.workspaceMovement.uninstall(),this.arrowNavigation.uninstall(),this.exitAction.uninstall(),this.enterAction.uninstall(),this.actionMenu.uninstall(),this.shortcutDialog.uninstall(),this.stackNavigationAction.uninstall();for(const t of Object.values(this.shortcuts))l.ShortcutRegistry.registry.unregister(t.name);this.removeShortcutHandlers(),this.navigation.dispose()}}const dt=new Map;function gt(t){if(!function(t){return t.type===l.Events.BLOCK_DRAG}(t))return;if(!t.blockId)return;const e=l.common.getWorkspaceById(t.workspaceId).getBlockById(t.blockId);if(!e)return;const o=l.Events.getRecordUndo();l.Events.setRecordUndo(!1),t.isStart?(dt.clear(),function(t){t.getDescendants(!1).forEach((t=>{const e=new Set(t.getDisabledReasons());dt.set(t.id,e),e.forEach((e=>t.setDisabledReason(!1,e)))}))}(e)):function(t){t.getDescendants(!1).forEach((t=>{var e;null===(e=dt.get(t.id))||void 0===e||e.forEach((e=>{t.setDisabledReason(!0,e)}))}))}(e),l.Events.setRecordUndo(o)}class ht extends l.Toast{static createDom(t,e){const o=super.createDom(t,e),n=o.querySelector("div");return n&&"element"in e&&e.element instanceof HTMLElement&&(n.innerHTML="",n.appendChild(e.element)),o}}class pt{constructor(t,e={allowCrossWorkspacePaste:!1}){var o,n;this.workspaceFocusRing=null,this.workspaceSelectionRing=null,this.oldWorkspaceResize=null,this.workspace=t,this.navigationController=new ut(e),this.navigationController.init(),this.navigationController.addWorkspace(t),this.navigationController.enable(t),this.cursor=new l.LineCursor(t),t.addChangeListener(gt);const i=t.getFlyout();if(null!=i&&i instanceof l.Flyout){const e=null!==(o=i.svgGroup_)&&void 0!==o?o:null;null===(n=null==e?void 0:e.parentElement)||void 0===n||n.insertBefore(e,t.getParentSvg())}this.oldWorkspaceResize=t.resize,t.resize=()=>{var t;null===(t=this.oldWorkspaceResize)||void 0===t||t.call(this.workspace),this.resizeWorkspaceRings()},this.workspaceSelectionRing=l.utils.dom.createSvgElement("rect",{fill:"none",class:"blocklyWorkspaceSelectionRing"}),t.getSvgGroup().appendChild(this.workspaceSelectionRing),this.workspaceFocusRing=l.utils.dom.createSvgElement("rect",{fill:"none",class:"blocklyWorkspaceFocusRing"}),t.getSvgGroup().appendChild(this.workspaceFocusRing),this.resizeWorkspaceRings(),l.dialog.setToast(ht.show.bind(ht))}resizeWorkspaceRings(){this.workspaceFocusRing&&this.workspaceSelectionRing&&(this.resizeFocusRingInternal(this.workspaceSelectionRing,5),this.resizeFocusRingInternal(this.workspaceFocusRing,0))}resizeFocusRingInternal(t,e){const o=this.workspace.getMetrics();t.setAttribute("x",(o.absoluteLeft+e).toString()),t.setAttribute("y",(o.absoluteTop+e).toString()),t.setAttribute("width",Math.max(0,o.viewWidth-2*e).toString()),t.setAttribute("height",Math.max(0,o.svgHeight-2*e).toString())}dispose(){var t,e;null===(t=this.workspaceFocusRing)||void 0===t||t.remove(),null===(e=this.workspaceSelectionRing)||void 0===e||e.remove(),this.oldWorkspaceResize&&(this.workspace.resize=this.oldWorkspaceResize),this.workspace.removeChangeListener(gt),this.navigationController.dispose()}toggleShortcutDialog(){this.navigationController.shortcutDialog.toggle(this.workspace)}static registerKeyboardNavigationStyles(){l.Css.register("\n  .blocklyDeleteIcon {\n    display: block;\n  }\n"),l.Css.register("\n  .injectionDiv {\n    --blockly-active-node-color: #fff200;\n    --blockly-active-tree-color: #60a5fa;\n    --blockly-selection-width: 3px;\n  }\n"),l.Css.register("\n  /* Active focus cases: */\n  /* Blocks with active focus. */\n  .blocklyKeyboardNavigation\n    .blocklyActiveFocus:is(.blocklyPath, .blocklyHighlightedConnectionPath),\n  /* Fields with active focus, */\n  .blocklyKeyboardNavigation\n    .blocklyActiveFocus.blocklyField\n    > .blocklyFieldRect,\n  /* Icons with active focus. */\n  .blocklyKeyboardNavigation\n    .blocklyActiveFocus.blocklyIconGroup\n    > .blocklyIconShape:first-child {\n    stroke: var(--blockly-active-node-color);\n    stroke-width: var(--blockly-selection-width);\n  }\n\n  /* Passive focus cases: */\n  /* Blocks with passive focus except when widget/dropdown div in use. */\n  .blocklyKeyboardNavigation:not(\n          :has(\n              .blocklyDropDownDiv:focus-within,\n              .blocklyWidgetDiv:focus-within\n            )\n        )\n    .blocklyPassiveFocus:is(\n      .blocklyPath:not(.blocklyFlyout .blocklyPath),\n      .blocklyHighlightedConnectionPath\n    ),\n  /* Fields with passive focus except when widget/dropdown div in use. */\n  .blocklyKeyboardNavigation:not(\n          :has(\n              .blocklyDropDownDiv:focus-within,\n              .blocklyWidgetDiv:focus-within\n            )\n        )\n    .blocklyPassiveFocus.blocklyField\n    > .blocklyFieldRect,\n  /* Icons with passive focus except when widget/dropdown div in use. */\n  .blocklyKeyboardNavigation:not(\n          :has(\n              .blocklyDropDownDiv:focus-within,\n              .blocklyWidgetDiv:focus-within\n            )\n        )\n    .blocklyPassiveFocus.blocklyIconGroup\n    > .blocklyIconShape:first-child {\n    stroke: var(--blockly-active-node-color);\n    stroke-dasharray: 5px 3px;\n    stroke-width: var(--blockly-selection-width);\n  }\n\n  /* Workaround for unexpectedly hidden connection path due to core style. */\n  .blocklyKeyboardNavigation\n    .blocklyPassiveFocus.blocklyHighlightedConnectionPath {\n    display: unset !important;\n  }\n"),l.Css.register("\n  /* Different ways for toolbox/flyout to be the active tree: */\n  /* Active focus in the flyout. */\n  .blocklyKeyboardNavigation .blocklyFlyout:has(.blocklyActiveFocus),\n  /* Active focus in the toolbox. */\n  .blocklyKeyboardNavigation .blocklyToolbox:has(.blocklyActiveFocus),\n  /* Active focus on the toolbox/flyout. */\n  .blocklyKeyboardNavigation\n    .blocklyActiveFocus:is(.blocklyFlyout, .blocklyToolbox) {\n    outline-offset: calc(var(--blockly-selection-width) * -1);\n    outline: var(--blockly-selection-width) solid\n      var(--blockly-active-tree-color);\n  }\n\n  /* Suppress default outline. */\n  .blocklyKeyboardNavigation\n    .blocklyToolboxCategoryContainer:focus-visible {\n    outline: none;\n  }\n"),l.Css.register("\n  /* Different ways for the workspace to be the active tree: */\n  /* Active focus within workspace. */\n  .blocklyKeyboardNavigation\n    .blocklyWorkspace:has(.blocklyActiveFocus)\n    .blocklyWorkspaceFocusRing,\n  /* Active focus within drag layer. */\n  .blocklyKeyboardNavigation\n    .blocklySvg:has(~ .blocklyBlockDragSurface .blocklyActiveFocus)\n    .blocklyWorkspaceFocusRing,\n  /* Active focus on workspace. */\n  .blocklyKeyboardNavigation\n    .blocklyWorkspace.blocklyActiveFocus\n    .blocklyWorkspaceFocusRing,\n  /* Focus in widget/dropdown div considered to be in workspace. */\n  .blocklyKeyboardNavigation:has(\n    .blocklyWidgetDiv:focus-within,\n    .blocklyDropDownDiv:focus-within\n  )\n    .blocklyWorkspace\n    .blocklyWorkspaceFocusRing {\n    stroke: var(--blockly-active-tree-color);\n    stroke-width: calc(var(--blockly-selection-width) * 2);\n  }\n\n  /* The workspace itself is the active node. */\n  .blocklyKeyboardNavigation\n    .blocklyWorkspace.blocklyActiveFocus\n    .blocklyWorkspaceSelectionRing {\n    stroke: var(--blockly-active-node-color);\n    stroke-width: var(--blockly-selection-width);\n  }\n"),l.Css.register("\n  .blocklyRTL .blocklyMenuItemContent .blocklyShortcutContainer {\n    flex-direction: row-reverse;\n  }\n  .blocklyMenuItemContent .blocklyShortcutContainer {\n    width: 100%;\n    display: flex;\n    justify-content: space-between;\n    gap: 16px;\n  }\n  .blocklyMenuItemContent .blocklyShortcutContainer .blocklyShortcut {\n    color: #ccc;\n  }\n")}}return r})()));
//# sourceMappingURL=index.js.map